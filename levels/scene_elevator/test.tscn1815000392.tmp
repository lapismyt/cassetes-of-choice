[gd_scene load_steps=13 format=3 uid="uid://bo38k4j1myyc5"]

[ext_resource type="Script" uid="uid://dbws8vlx4mcwv" path="res://scene1/player.gd" id="2_jbpj8"]
[ext_resource type="Script" uid="uid://c125qjncetr53" path="res://scene1/randomMovement.gd" id="3_rhb12"]
[ext_resource type="Material" uid="uid://cuxpu1y012fpk" path="res://vhs.tres" id="4_t7ald"]

[sub_resource type="GDScript" id="GDScript_cyhdp"]
script/source = "extends Node3D

@export var mob_scenes : Array[PackedScene]
@export var max_mobs = 50
@export var spawn_radius = 30.0

var current_mobs = 0
var player : Node3D
var noise = FastNoiseLite.new()
var mob_pool = [] 

func _ready():
	player = get_tree().get_first_node_in_group(\"player\")
	noise.seed = randi()
	initialize_pool()

# Инициализация пула мобов
func initialize_pool():
	for i in range(max_mobs):
		var mob = get_random_mob().instantiate()
		mob.visible = false
		mob.process_mode = Node.PROCESS_MODE_DISABLED
		add_child(mob)
		mob_pool.append(mob)
		mob.connect(\"died\", _on_mob_died)  # Подключаем сигнал смерти

# Вместо get_available_mob используем этот метод
func get_inactive_mob() -> Node3D:
	for mob in mob_pool:
		if !mob.visible:
			mob.process_mode = Node.PROCESS_MODE_INHERIT
			mob.visible = true
			return mob
	return null  # Если нет свободных мобов

func _process(delta):
	if current_mobs < max_mobs:
		try_spawn_mob()

func try_spawn_mob():
	var spawn_pos = calculate_spawn_position()
	if is_position_valid(spawn_pos):
		var mob = get_inactive_mob()
		if mob:
			mob.global_position = spawn_pos
			current_mobs += 1

# Остальные методы остаются без изменений
func calculate_spawn_position() -> Vector3:
	var angle = randf() * TAU
	var distance = spawn_radius * (0.8 + noise.get_noise_1d(Time.get_ticks_msec()) * 0.3)
	return player.global_position + Vector3(
		cos(angle) * distance,
		0,
		sin(angle) * distance
	)

func is_position_valid(pos: Vector3) -> bool:
	var space = get_world_3d().direct_space_state
	var query = PhysicsRayQueryParameters3D.create(
		player.global_position,
		pos,
		1
	)
	return !space.intersect_ray(query)

func get_random_mob() -> PackedScene:
	return mob_scenes.pick_random()

func _on_mob_died():
	current_mobs -= 1
"

[sub_resource type="CapsuleShape3D" id="CapsuleShape3D_iyo7h"]

[sub_resource type="CapsuleMesh" id="CapsuleMesh_iyo7h"]

[sub_resource type="BoxMesh" id="BoxMesh_iyo7h"]

[sub_resource type="HeightMapShape3D" id="HeightMapShape3D_iyo7h"]

[sub_resource type="CylinderShape3D" id="CylinderShape3D_iyo7h"]

[sub_resource type="CylinderMesh" id="CylinderMesh_5s0of"]

[sub_resource type="NavigationMesh" id="NavigationMesh_5s0of"]
region_merge_size = 31.05

[sub_resource type="BoxMesh" id="BoxMesh_eq1sr"]

[node name="Node3D" type="Node3D"]
script = SubResource("GDScript_cyhdp")

[node name="DirectionalLight3D" type="DirectionalLight3D" parent="."]
transform = Transform3D(1, 0, 0, 0, -0.00844735, 0.999964, 0, -0.999964, -0.00844735, 0, 22.7936, -1.87659)
light_bake_mode = 1

[node name="OmniLight3D" type="OmniLight3D" parent="."]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -9.19153, 2.49377, 0)
light_color = Color(0.757289, 0.873432, 0.972632, 1)
light_energy = 2.939
light_size = 0.293
light_specular = 8.258
light_bake_mode = 1
distance_fade_enabled = true
omni_range = 7.511

[node name="Player" type="CharacterBody3D" parent="."]
collision_layer = 2
platform_floor_layers = 4294967043
platform_wall_layers = 3
script = ExtResource("2_jbpj8")

[node name="CollisionShape3D" type="CollisionShape3D" parent="Player"]
shape = SubResource("CapsuleShape3D_iyo7h")
debug_color = Color(0.921569, 0, 0.690196, 0.145098)

[node name="fpCamera" type="Camera3D" parent="Player"]

[node name="MeshInstance3D" type="MeshInstance3D" parent="Player"]
layers = 2
extra_cull_margin = 4300.52
mesh = SubResource("CapsuleMesh_iyo7h")

[node name="SpotLight3D" type="SpotLight3D" parent="Player"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 1.25452, -0.0788574, 0.421631)

[node name="floor" type="StaticBody3D" parent="."]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, -2.16321, 0)
collision_mask = 2

[node name="MeshInstance3D" type="MeshInstance3D" parent="floor"]
transform = Transform3D(22, 0, 0, 0, 1, 0, 0, 0, 22, 0, -0.941895, 0)
mesh = SubResource("BoxMesh_iyo7h")

[node name="CollisionShape3D" type="CollisionShape3D" parent="floor"]
transform = Transform3D(22, 0, 0, 0, 22, 0, 0, 0, 22, 0, -0.401245, 0)
shape = SubResource("HeightMapShape3D_iyo7h")
debug_color = Color(0, 0.6, 0.701961, 0.14902)

[node name="mob" type="CharacterBody3D" parent="."]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -4.61731, -0.630005, -4.32837)
script = ExtResource("3_rhb12")

[node name="CollisionShape3D" type="CollisionShape3D" parent="mob"]
shape = SubResource("CylinderShape3D_iyo7h")

[node name="MeshInstance3D" type="MeshInstance3D" parent="mob"]
mesh = SubResource("CylinderMesh_5s0of")
skeleton = NodePath("../CollisionShape3D")

[node name="NavigationAgent3D" type="NavigationAgent3D" parent="mob"]
navigation_layers = 7

[node name="NavigationRegion3D" type="NavigationRegion3D" parent="."]
navigation_mesh = SubResource("NavigationMesh_5s0of")
navigation_layers = 7

[node name="ColorRect" type="ColorRect" parent="."]
material = ExtResource("4_t7ald")
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
color = Color(0.548265, 0.1193, 0.480669, 1)

[node name="MeshInstance3D" type="MeshInstance3D" parent="."]
transform = Transform3D(9.03893, 0, 0.748568, 0, 16, 0, -11.9707, 0, 0.565234, -9.07639, 3.30945, -2.38342)
visibility_range_end_margin = 50.0
mesh = SubResource("BoxMesh_eq1sr")

[node name="MeshInstance3D2" type="MeshInstance3D" parent="MeshInstance3D"]
transform = Transform3D(-0.823651, 0, -0.0354624, 0, 1, 0, 9.06871, 0, -0.823651, 0.621169, 0, 14.8156)
visibility_range_end_margin = 50.0
mesh = SubResource("BoxMesh_eq1sr")
skeleton = NodePath("../..")

[node name="MeshInstance3D3" type="MeshInstance3D" parent="MeshInstance3D"]
transform = Transform3D(0.647508, 0, -0.0476541, 0, 1, 0, 12.1864, 0, 0.647508, 0.760948, 0, 5.26792)
visibility_range_end_margin = 50.0
mesh = SubResource("BoxMesh_eq1sr")
skeleton = NodePath("../..")

[node name="MeshInstance3D4" type="MeshInstance3D" parent="MeshInstance3D"]
transform = Transform3D(0.606311, -0.846751, -0.00294743, 0.0536486, 0.102671, -0.0582186, 12.6839, 10.2245, 0.107678, 0.318281, 0.535072, 10.6131)
visibility_range_end_margin = 50.0
mesh = SubResource("BoxMesh_eq1sr")
skeleton = NodePath("../..")
